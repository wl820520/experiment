<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>实验台管理--实验管理</title>
<link rel="stylesheet" href="/html/admin/css/style.default.css" type="text/css" />
    <script src="/js/jquery-1.10.2.js"></script>
<!--[if IE 9]>
    <link rel="stylesheet" media="screen" href="/html/admin/css/style.ie9.css"/>
<![endif]-->
<!--[if IE 8]>
    <link rel="stylesheet" media="screen" href="/html/admin/css/style.ie8.css"/>
<![endif]-->
<!--[if lt IE 9]>
	<!--<script src="js/plugins/css3-mediaqueries.js"></script>-->
<![endif]-->
</head>

<body class="withvernav">
<div class="bodywrapper">
    <div th:include="html/admin/inner :: copyheader ('experiment')"></div>

    <div class="centercontent">

        <div class="pageheader">
            <h1 class="pagetitle">实验管理</h1>
            <ul class="hornav">
                <li class="current"><a>基础实验类型管理</a></li>
            </ul>
        </div><!--pageheader-->

        <div id="contentwrapper" class="contentwrapper">

            <div id="inbox" class="subcontent">

                <div class="msghead">
                    <p>
                        <label>答案类型</label>
                        <span class="field"><select id="selectype"><option value="0">说明页</option><option value="1">选择题</option><option value="2">填空题</option><option value="3">表格题</option></select></span>
                    </p>
                    <p>
                        <label>试题类型(字段名称)</label>
                        <span class="field">
                            <select id="selectqtype">
                                <option th:each="product:${qtlist}" th:text="${product.name}"  th:value="${product.id}"></option>
                            </select>
                        </span>
                    </p>
                    <p>
                        <label>图片地址(非图片填空)</label>
                        <span class="field"><input type="text" value="" id="pic" placeholder="图片地址"/></span>
                    </p>
                    <p name="val" style="display: none">
                        <label>分数</label>
                        <span class="field"><input type="text" id="score" placeholder="0"/></span>
                    </p>
                    <p name="val" style="display: none">
                        <label>最小值</label>
                        <span class="field"><input type="text" id="minvalue" placeholder="0"/></span>
                    </p>
                    <p name="val" style="display: none">
                        <label>最大值</label>
                        <span class="field"><input type="text" id="maxvalue" placeholder="0"/></span>
                    </p>
                    <p name="val" style="display: none">
                        <label>单位</label>
                        <span class="field"><input type="text" id="unit" placeholder="V"/></span>
                    </p>
                    <p>
                        <label>标题</label>
                        <span class="field"><input type="text" id="title" placeholder="标题"/></span>
                    </p>
                    <p>
                        <label>按钮文字</label>
                        <span class="field"><input type="text" id="button_text" value="下一页" placeholder="下一页"/></span>
                    </p>
                    <p>
                        <label>排序</label>
                        <span class="field"><input type="text" id="sort" placeholder="100  越小越靠前"/></span>
                    </p>
                    <p class="stdformbutton">
                        <input type="button" value="添加试题" id="addquestion"/>
                    </p>
                    <span class="clearall"></span>
                </div><!--msghead-->

                <table cellpadding="0" cellspacing="0" border="0" class="stdtable mailinbox">
                    <colgroup>
                        <col class="con1" width="4%"/>
                        <col class="con0" width="15%" />
                        <col class="con1" width="15%"/>
                        <col class="con0" width="15%"/>
                        <col class="con1" width="15%"/>
                    </colgroup>
                    <thead>
                    <tr>
                        <th width="20" class="head1 aligncenter"><input type="checkbox" name="checkall" class="checkall" /></th>
                        <th class="head0 attachement">id</th>
                        <th class="head1">试题类型</th>
                        <th class="head1">类型字段</th>
                        <th class="head0">分数</th>
                        <th class="head1">值区间</th>
                        <th class="head0">标题</th>
                        <th class="head1">排序</th>
                        <th class="head0">答案管理</th>
                        <th class="head1">操作</th>
                    </tr>
                    </thead>
                    <tfoot>
                    <tr>
                        <th class="head1 aligncenter"><input type="checkbox" name="checkall" class="checkall2" /></th>
                        <th class="head0 attachement">id</th>
                        <th class="head1">试题类型</th>
                        <th class="head1">类型字段</th>
                        <th class="head0">分数</th>
                        <th class="head1">值区间</th>
                        <th class="head0">标题</th>
                        <th class="head1">排序</th>
                        <th class="head0">答案管理</th>
                        <th class="head1">操作</th>
                    </tr>
                    </tfoot>
                    <tbody id="userlist">
                        <tr th:each="product:${qlist}">
                            <td class="aligncenter"><input type="checkbox" name="" /></td>
                            <td type="id" th:text="${product.id}">1</td>
                            <td th:text="${product.type==0?'说明页':(product.type==1?'选择题':(product.type==2?'填空题':'表格题'))}">Red Chair</td>
                            <td th:text="${product.typename}"></td>
                            <td th:text="${product.score}"></td>
                            <td th:text="${product.minvalue+' - '+product.maxvalue}"></td>
                            <td th:text="${product.title}"></td>
                            <td th:text="${product.sort}"></td>
                            <td><a t='checkbase' class="btn btn4 btn_link"></a></td>
                            <td><a t='update' class="btn btn4 btn_link"></a><a t='del' class="btn btn4 btn_trash"></a></td>
                        </tr>
                    </tbody>
                </table>

                <p>
                    <label>上传图片</label>
                    <br class="field">
                    <input type="file" name="uppic" id="uppic" /><br/>
                    <span id="picpath"></span><br />
                    <img id="img" width="150px" height="150px" />
                    </span>
                </p>
            </div>
        </div><!--contentwrapper-->

    </div><!--centercontent-->


</div><!--bodywrapper-->

<script type="text/javascript">
    $(function () {
        $("#selectype").change(function () {
            var t=$(this).val()
            if(t=="2"){
                $("p[name='val']").show();
            }else{
                $("p[name='val']").hide();
            }
        })

        var base64="";
        $("#uppic").change(function(){
            var file = this.files[0];
            if(!/image\/\w+/.test(file.type)){
                alert("文件必须为图片！");
                return false;
            }
            $("#img").attr("src",URL.createObjectURL($(this)[0].files[0]));
            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function (e) { base64= this.result; }
            var file = document.querySelector('[type=file]');
            // 通过FormData将文件转成二进制数据
            var formData = new FormData();
            // 将文件转二进制
            formData.append('pic', file.files[0]);
            console.log(formData)
            $.ajax({
                url:"admin/uploadpic",
                type:"post",
                data:formData,
                processData:false,
                contentType:false,
                success:function(data){
                    console.log(data);
                    if(data.code==1){
                        $("#picpath").text(data.data)
                        $("#pic").val(data.data)
                    }else{
                        $("#picpath").text("上传图片失败")
                    }
                }
            });
        });

        var id=0;
        $("#seletype").bind("change",function () {
            console.log("change")
            if($(this).val()=="0") {
                $("#val").show();
            }else{
                $("#val").hide();
            }
        })
        $("#addquestion").click(function () {
            postdata(id);
        })
        //获取url中的参数
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i"); // 匹配目标参数
            var result = window.location.search.substr(1).match(reg); // 对querystring匹配目标参数
            if (result != null) {
                return decodeURIComponent(result[2]);
            } else {
                return null;
            }
        }

        function postdata(id) {
            if($("#type").val()==""){
                alert("试题类型字段不能为空")
                return
            }
            $.ajax({
                url:"/admin/addquestion",
                type:"post",
                data:JSON.stringify({
                    id:id,
                    base_id:getQueryString("id"),
                    maxvalue:$("#maxvalue").val(),
                    minvalue:$("#minvalue").val(),
                    typename:$("#typename").val(),
                    type:$("#selectqtype").val(),
                    ispic:$("#pic").val()==""?0:1,
                    score:$("#score").val(),
                    title:$("#title").val(),
                    pic:$("#pic").val(),
                    button_text:$("#button_text").val(),
                    unit:$("#unit").val(),
                    sort:$("#sort").val()
                }),
                contentType : 'application/json',
                processData:false,
                success:function(data){
                    console.log(data);
                    if(data.code==1){
                        location.href=location.href
                    }else{
                        alert(data.msg)
                    }
                }
            });
        }
        function bindclick() {
            $("a[t='del']").click(function () {
                if(confirm("确定删除？")) {
                    var aid = $(this).parent().parent().find("td[type='id']").html()
                    $.ajax({
                        url: "/admin/delquestion", data: {id: aid}, success: function (result) {
                            if (result && result.code == 1) {
                                alert("删除成功");
                                location.href = location.href;
                            } else {
                                alert("删除失败")
                            }
                        }
                    });
                }
            })
            $("a[t='update']").click(function () {
                var json = $(this).parent().parent()
                $("#typetitle").val(json.find("td[type='title']").html())
                $("#typename").val(json.find("td[type='name']").html())
                id=json.find("td[type='id']").html()
            })

            $("a[t='checkbase']").click(function () {
                var json = $(this).parent().parent()
                var type=json.find("td[type='type']").html()
                if(type!="0"){
                    location.href="/admin/questionlist?id="+json.find("td[type='id']").html()
                }else{
                    alert("值类型不需要管理试题")
                }
            })
        }
        bindclick()
    });
</script>
</body>
</html>
